
#delta opening & closing SOH
create or replace view KSFPA.FINANCE_PVT.RFID_OPENING_CLOSING_SOH(
	STORE_NO,
	KEYCODE,
	DAY_DATE,
	DAILY_STOCK_ON_HAND_QUANTITY
) as 
select
--PP.DEPARTMENT_DESCRIPTION,
--PP.PRODUCT_DESCRIPTION,
cast(substr(SOH.LOCATION_GENERATED_IDENTIFIER,5,4) as varchar(38)) as STORE_NO,
cast(substr(SOH.PRODUCT_GENERATED_IDENTIFIER,0,8) as varchar(38))  as KEYCODE,
DAY_DATE,
DAILY_STOCK_ON_HAND_QUANTITY
--DENSE_RANK() OVER(PARTITION BY STORE_NO, KEYCODE  ORDER BY DAY_DATE DESC) AS CLOSING_SOH_FLAG
--RANK() OVER(PARTITION BY KEYCODE,STORE_NO  ORDER BY '2022-02-13' ASC) AS OPENING_SOH_FLAG, 
--ROW_NUMBER() OVER(PARTITION BY KEYCODE ORDER BY DAY_DATE ) AS ROW_NO
from "KSFPA"."MR2C"."DAILY_SOH" SOH
--left join "KSF_SOPHIA_DATA_INTELLIGENCE_HUB_PROD"."COMMON_DIMENSIONS"."DIM_PRODUCT" pp
--on PP.PRODUCT_KEYCODE = cast(substr(SOH.LOCATION_GENERATED_IDENTIFIER,5,4) as varchar(38))
where DAILY_STOCK_ON_HAND_QUANTITY is not null 
and DAY_DATE in (Select max(DAY_DATE) from "KSFPA"."MR2C"."DAILY_SOH") 
OR DAY_DATE = '2022-08-05'
--AND PP.PRODUCT_DESCRIPTION <> 'undefined'
--(Select DAY_DATE = '2022-08-06' from "KSFPA"."MR2C"."DAILY_SOH")
 --DAILY_STOCK_ON_HAND_QUANTITY <> 0 and DAILY_STOCK_ON_HAND_QUANTITY is not null 
 --SOH.DAY_DATE >= '2022-02-13'  
--AND STORE_NO = 1217
--) Y
--WHERE Y.CLOSING_SOH_FLAG = 1
--AND Y.STORE_NO = 1001
--and Y.DAILY_STOCK_ON_HAND_QUANTITY<=0
--AND Y.OPENING_SOH_FLAG = 1
ORDER BY DAILY_STOCK_ON_HAND_QUANTITY ASC;



#Last Stocktake SOH
create or replace view KSFPA.FINANCE_PVT.MANIFEST_LAST_STK_SOH_VIEW(
	STORE_NO,
	KEYCODE,
	LAST_STK_DATE,
	DAILY_STOCK_ON_HAND_QUANTITY
) as
select
cast(substr(SOH.LOCATION_GENERATED_IDENTIFIER,5,4) as varchar(38)) as STORE_NO,
cast(substr(SOH.PRODUCT_GENERATED_IDENTIFIER,0,8) as varchar(38))  as KEYCODE,
 STK.LAST_STK_DATE,
--SOH.DAY_DATE,
SOH.DAILY_STOCK_ON_HAND_QUANTITY
--RANK() OVER(PARTITION BY KEYCODE ORDER BY DAY_DATE DESC) AS CLOSING_SOH_FLAG,
--RANK() OVER(PARTITION BY KEYCODE ORDER BY DAY_DATE desc) AS CLOSING_SOH_FLAG,
--RANK() OVER(PARTITION BY KEYCODE,STORE_NO ORDER BY STK.LAST_STK_DATE desc) AS OPENING_SOH_FLAG 
--ROW_NUMBER() OVER(PARTITION BY KEYCODE,STORE_NO ORDER BY STK.LAST_STK_DATE desc  ) AS ROW_NO,
--STK.LAST_STK_DATE
from "KSFPA"."MR2C"."DAILY_SOH" SOH
LEFT JOIN "KSFPA"."LOSS_PREVENTION_PVT"."STK_STRS_WITH_STK_DATE_VD" STK
 ON SOH.DAY_DATE = STK.LAST_STK_DATE
AND cast(substr(SOH.LOCATION_GENERATED_IDENTIFIER,5,4) as varchar(38)) = STK.LOCATION_SOURCE_IDENTIFIER
where SOH.DAY_DATE = STK.LAST_STK_DATE
 ORDER BY DAILY_STOCK_ON_HAND_QUANTITY asc;














#RFID LAG ADJ VIEW
create or replace view KSFPA.FINANCE_PVT.RFID_ADJ_LAG AS 
SELECT  
Y.STOREID,
Y.KEYCODE,
Y.QUANTITYRECORDED,	
--Y.FIRSTSNAPSHOTDATETIME,	
--Y.LASTSNAPSHOTDATETIME,
Y.INSERT_TIMESTAMP,
Y.QUANTITYIPS,
Y.QUANTITYRECORDED - Y.QUANTITYIPS AS ADJ_QTY,
LAG(ADJ_QTY,1) OVER(PARTITION BY Y.KEYCODE, Y.STOREID  ORDER BY Y.INSERT_TIMESTAMP ASC) as ADJ_LAG_QTY,
ADJ_QTY - ADJ_LAG_QTY AS RFID_ADJ,
RANK() OVER(PARTITION BY Y.KEYCODE, Y.STOREID  ORDER BY Y.INSERT_TIMESTAMP ASC) AS RANK
FROM "KSFPA"."DOSA_SYSPRO"."SYSPRO_DELTA_ADJUSTMENT" Y









#manifest-delta-sales exact negation view
create or replace view KSFPA.FINANCE_PVT.MANIFEST_DELTA_SLS_A_VIEW(
	TRANSFER_GENERATED_IDENTIFIER,
	DC_NO,
	DESPATCH_DATE,
	TRANSFER_TYPE_CODE,
	STORE_NO,
	KEYCODE,
	DESPATCH_QUANTITY,
	RECEIPT_DATE,
	QUANTITYRECORDED,
	INSERT_TIMESTAMP,
	QUANTITYIPS,
	ADJ_QTY,
	ADJ_LAG_QTY,
	RFID_ADJ,
	RANK,
	SALE_DATE,
	DAILY_NET_SELL_AMOUNT,
	DAILY_NET_SALES_QUANTITY,
	EFFECTIVE_DATE,
	EXPIRY_DATE,
	LOCATION_AWC_AMOUNT,
	LOCATION_AWC_AMOUNT_NZD
) as

SELECT * FROM
(SELECT  
X.TRANSFER_GENERATED_IDENTIFIER,	
X.DC_NO,	
X.DESPATCH_DATE,	
X.TRANSFER_TYPE_CODE,	
X.STORE_NO,	
X.KEYCODE,	
X.DESPATCH_QUANTITY,
X.RECEIPT_DATE,
--Y.STOREID,
--Y.KEYCODE,
Y.QUANTITYRECORDED,	
--Y.FIRSTSNAPSHOTDATETIME,	
--Y.LASTSNAPSHOTDATETIME,
Y.INSERT_TIMESTAMP,
Y.QUANTITYIPS,
Y.ADJ_QTY,
Y.ADJ_LAG_QTY,
Y.RFID_ADJ,
Y.RANK,
Z.DAY_DATE AS SALE_DATE,
Z.DAILY_NET_SELL_AMOUNT,
Z.DAILY_NET_SALES_QUANTITY,
W.EFFECTIVE_DATE,
W.EXPIRY_DATE,
W.LOCATION_AWC_AMOUNT,
W.LOCATION_AWC_AMOUNT_NZD

FROM "KSFPA"."FINANCE_PVT"."RFID_ADJ_LAG" Y
LEFT JOIN "KSFPA"."FINANCE_PVT"."SUPPLIER_MAIFEST_VIEW_A" X
ON X.KEYCODE = Y.KEYCODE
AND X.STORE_NO = Y.STOREID
LEFT JOIN  "KSFPA"."MR2C"."DAILY_POS_SALES" Z
ON cast(substr(Z.LOCATION_GENERATED_IDENTIFIER,5,4) as varchar(38)) = Y.STOREID
AND cast(substr(Z.PRODUCT_GENERATED_IDENTIFIER,0,8) as varchar(38)) = Y.KEYCODE
LEFT JOIN "KSFPA"."MR2"."SS_AVERAGE_WEIGHTED_COST" W
ON cast(substr(W.LOCATION_GENERATED_IDENTIFIER,5,4) as varchar(38)) = Y.STOREID
AND cast(substr(W.PRODUCT_GENERATED_IDENTIFIER,0,8) as varchar(38)) = Y.KEYCODE
WHERE 
 DESPATCH_QUANTITY = ABS(RFID_ADJ)
-- DESPATCH_QUANTITY=ABS(ADJ_LAG)
AND
SALE_DATE >= DESPATCH_DATE -10
and EFFECTIVE_DATE IN (SELECT MAX(EFFECTIVE_DATE) FROM "KSFPA"."MR2"."SS_AVERAGE_WEIGHTED_COST")
) A
--WHERE 
--STORE_NO = 1001
--AND KEYCODE = 69256684
--AND 
order by A.RANK asc;




TEST 123